<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flow up by zubayer</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <!-- html2canvas for image download -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <style>
    /* Global & Wrapper Styles */
    body, html { height: 100%; margin: 0; }
    .wrapper { display: flex; flex-direction: column; min-height: 100%; }
    .content { flex: 1; position: relative; padding-top: 70px; }
    body, h1, h2, h3, h4, h5, h6, p, label, input, select, button, a {
      color: #212529; font-weight: bold; font-family: "Courier New", Courier, monospace; transition: all 0.3s ease;
    }
    body { background-color: #f8f9fa; }
    /* Navbar */
    .navbar { background-color: #dc3545; padding: 1rem; position: fixed; top: 0; width: 100%; z-index: 1050; display: flex; justify-content: space-between; align-items: center; }
    .navbar-brand small { font-size: 1rem; margin-left: 5px; color: #f1f1f1; }
    #searchIconBtn, #profileIconBtn { background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; margin-left: 10px; }
    .action-container { display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin: 2rem 0; }
    .search-box { width: 0; opacity: 0; transition: width 0.3s ease, opacity 0.3s ease; overflow: hidden; }
    .search-box.active { width: 200px; opacity: 1; }
    /* Card Styles */
    .card { background-color: #fff; border: 1px solid #ced4da; margin-bottom: 1rem; opacity: 0; transform: translateY(20px); animation: fadeIn 0.5s forwards; }
    @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    .card-header { background-color: #b3d7ff; padding: 0.5rem 1rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #80bfff; box-shadow: 0px 2px 5px rgba(0,0,0,0.1); }
    .card-header h5 { margin: 0; }
    .timestamp, .progress-timestamp { font-size: 0.7rem; color: #6c757d; }
    .dot-btn { background: none; border: none; color: #212529; font-size: 1.8rem; cursor: pointer; transition: color 0.3s ease; }
    .dot-btn:hover { color: #dc3545; }
    .priority-line, .status-line { display: flex; align-items: center; margin-bottom: 0.5rem; }
    .priority-line small, .status-line small { margin-right: 5px; }
    .task-progress { min-width: 150px; cursor: pointer; }
    .progress-text { font-size: 1.2rem; margin-top: 0.3rem; }
    .show-more { color: #007bff; text-decoration: underline; cursor: pointer; margin-top: 0.5rem; display: inline-block; }
    .comment-section { padding: 0.5rem 1rem; border-top: 1px solid #ced4da; background-color: #f1f3f5; }
    /* Comment Styling */
    .comment { border-bottom: 1px solid #dee2e6; padding: 0.5rem 0; position: relative; }
    .comment:last-child { border-bottom: none; }
    .comment-header { display: flex; justify-content: space-between; align-items: center; }
    .comment .comment-author { font-size: 0.9rem; color: #343a40; }
    .comment .comment-timestamp { font-size: 0.8rem; color: #6c757d; }
    .comment .comment-text { margin-top: 0.2rem; font-size: 1.5rem; }
    .comment-options-btn { background: none; border: none; font-size: 1rem; cursor: pointer; color: #6c757d; }
    .comment-options-btn:hover { color: #dc3545; }
    /* Modals */
    .modal-content { background-color: #fff; border: 1px solid #dc3545; }
    .btn-modal { background-color: #dc3545; border: none; color: #fff; }
    .btn-modal:hover { background-color: #bb2d3b; }
    /* Toast Container: ensure it appears above modals */
    #toastContainer { position: fixed; top: 80px; right: 1rem; z-index: 2000; }
    /* Footer */
    footer { background-color: #e9ecef; color: #212529; padding: 20px 0; }
    footer .container { display: flex; flex-wrap: wrap; justify-content: space-around; align-items: center; text-align: center; }
    footer a { color: #212529; margin: 0 10px; text-decoration: none; }
    footer a:hover { color: #007bff; }
    footer .social-icons i { font-size: 1.5em; margin-right: 10px; }
    footer .qr-code img { width: 100px; }
    /* Spinner Overlay */
    .spinner-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; align-items: center; justify-content: center; z-index: 999; }
  </style>
</head>
<body>
  <div class="wrapper">
    <!-- Content -->
    <div class="content">
      <!-- Navbar -->
      <nav class="navbar">
        <span class="navbar-brand">
          <i class="bi bi-card-checklist"></i> FLOW UP 
          <small class="text-muted"> by zubayer</small>
        </span>
        <div>
          <button id="searchIconBtn"><i class="bi bi-search"></i></button>
          <button id="profileIconBtn" style="display:none;"><i class="bi bi-person-circle"></i></button>
        </div>
      </nav>

      <!-- Main App Section -->
      <div id="app-section" class="container mb-4" style="display:none;">
        <div class="action-container">
          <input type="text" id="searchBox" class="form-control search-box" placeholder="সার্চ করুন..." />
          <button id="addTaskBtn" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#addTaskModal">
            <i class="bi bi-plus-circle-fill"></i> Add Task
          </button>
        </div>
        <div id="taskContainer"></div>
      </div>

      <!-- Toast Container -->
      <div id="toastContainer"></div>

      <!-- Task Options Modal -->
      <div class="modal fade" id="taskOptionsModal" tabindex="-1" aria-labelledby="taskOptionsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="taskOptionsModalLabel">টাস্ক অপশন</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
              <button type="button" class="btn btn-info mb-2" id="downloadTaskBtn">Download as Image</button>
              <br />
              <button type="button" class="btn btn-modal" id="editTaskOptionBtn" style="display: none;">এডিট করুন</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Task Modal -->
      <div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addTaskModalLabel"><i class="bi bi-plus-square"></i> নতুন টাস্ক যোগ করুন</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="newTaskName">টাস্কের নাম</label>
                <input type="text" id="newTaskName" class="form-control" placeholder="টাস্কের নাম লিখুন" />
              </div>
              <div class="mb-3">
                <label for="newTaskPriority">Priority:</label>
                <select id="newTaskPriority" class="form-select">
                  <option value="low">নিম্ন (Low)</option>
                  <option value="medium">মাঝারি (Medium)</option>
                  <option value="high">উচ্চ (High)</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="newTaskProgress">প্রগ্রেস (%)</label>
                <input type="number" id="newTaskProgress" class="form-control" value="0" min="0" max="100" />
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-modal" id="saveNewTaskBtn">সেভ করুন</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ক্যান্সেল</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Task Modal -->
      <div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editTaskModalLabel"><i class="bi bi-pencil-square"></i> টাস্ক এডিট করুন</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="editTaskName">টাস্কের নাম</label>
                <input type="text" id="editTaskName" class="form-control" />
              </div>
              <div class="mb-3">
                <label for="editTaskPriority">Priority:</label>
                <select id="editTaskPriority" class="form-select">
                  <option value="low">নিম্ন (Low)</option>
                  <option value="medium">মাঝারি (Medium)</option>
                  <option value="high">উচ্চ (High)</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="editTaskProgress">প্রগ্রেস (%)</label>
                <input type="number" id="editTaskProgress" class="form-control" min="0" max="100" />
              </div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
              <button type="button" class="btn btn-danger" onclick="openDeleteModal(selectedTaskId)">
                <i class="bi bi-trash"></i> Delete
              </button>
              <div>
                <button type="button" class="btn btn-modal" id="saveEditTaskBtn">সেভ করুন</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ক্যান্সেল</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Delete Task Confirmation Modal -->
      <div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="deleteTaskModalLabel"><i class="bi bi-exclamation-triangle-fill"></i> টাস্ক ডিলিট করুন</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>আপনি কি নিশ্চিতভাবে এই টাস্কটি ডিলিট করতে চান?</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-modal" id="confirmDeleteTaskBtn">হ্যাঁ, ডিলিট করুন</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ক্যান্সেল</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Update Progress Modal -->
      <div class="modal fade" id="updateProgressModal" tabindex="-1" aria-labelledby="updateProgressModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="updateProgressModalLabel">প্রগ্রেস আপডেট করুন</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <label for="newProgressInput">নতুন প্রগ্রেস (%) (0-100):</label>
              <input type="number" id="newProgressInput" class="form-control" min="0" max="100" placeholder="0" />
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-modal" id="saveProgressBtn">সেভ করুন</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ক্যান্সেল</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Comment Options Modal -->
      <div class="modal fade" id="commentOptionsModal" tabindex="-1" aria-labelledby="commentOptionsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="commentOptionsModalLabel">কমেন্ট অপশন</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
              <!-- নিজের কমেন্ট হলে এডিট ও ডিলিট দেখাবে -->
              <button type="button" class="btn btn-warning mb-2" id="editCommentBtn">এডিট</button>
              <br />
              <button type="button" class="btn btn-danger" id="deleteCommentBtn">ডিলিট</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Comment Edit Modal -->
      <div class="modal fade" id="commentEditModal" tabindex="-1" aria-labelledby="commentEditModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="commentEditModalLabel">কমেন্ট এডিট করুন</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <label for="editCommentInput">নতুন কমেন্ট:</label>
              <textarea id="editCommentInput" class="form-control" rows="3"></textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-modal" id="saveCommentEditBtn">সেভ করুন</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ক্যান্সেল</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Comment Delete Confirmation Modal -->
      <div class="modal fade" id="commentDeleteModal" tabindex="-1" aria-labelledby="commentDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="commentDeleteModalLabel">কমেন্ট ডিলিট করুন</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>আপনি কি নিশ্চিতভাবে এই কমেন্টটি ডিলিট করতে চান?</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-modal" id="confirmCommentDeleteBtn">হ্যাঁ, ডিলিট করুন</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ক্যান্সেল</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Profile Modal -->
      <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="profileModalLabel">প্রোফাইল</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p id="userNameDisplay">নাম: </p>
              <p id="userEmailDisplay">ইমেইল: </p>
              <p id="userRoleDisplay">রোল: </p>
              <button class="btn btn-secondary w-100" data-bs-toggle="modal" data-bs-target="#passwordModal">
                পাসওয়ার্ড পরিবর্তন করুন
              </button>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-modal" id="modalLogoutBtn">লগআউট</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">বন্ধ করুন</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Password Change Modal -->
      <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="passwordModalLabel">পাসওয়ার্ড পরিবর্তন করুন</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="currentPassword">বর্তমান পাসওয়ার্ড</label>
                <input type="password" id="currentPassword" class="form-control" placeholder="বর্তমান পাসওয়ার্ড" />
              </div>
              <div class="mb-3">
                <label for="newPassword">নতুন পাসওয়ার্ড</label>
                <input type="password" id="newPassword" class="form-control" placeholder="নতুন পাসওয়ার্ড" />
              </div>
              <div class="mb-3">
                <label for="confirmPassword">নতুন পাসওয়ার্ড নিশ্চিত করুন</label>
                <input type="password" id="confirmPassword" class="form-control" placeholder="পুনরায় লিখুন" />
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-modal" id="changePasswordBtn">পরিবর্তন করুন</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ক্যান্সেল</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Footer -->
    <footer>
      <div class="container">
        <div class="mb-3">
          <strong>কোম্পানি: XYZ লিমিটেড</strong><br />
          <a href="https://facebook.com/yourpage" target="_blank"><i class="bi bi-facebook"></i> Facebook</a>
          <a href="https://instagram.com/yourprofile" target="_blank"><i class="bi bi-instagram"></i> Instagram</a>
          <a href="https://t.me/yourchannel" target="_blank"><i class="bi bi-telegram"></i> Telegram</a>
        </div>
        <div class="mb-3 qr-code">
          <img src="https://api.qrserver.com/v1/create-qr-code/?data=01841246223&size=100x100" alt="WhatsApp QR Code" />
          <p>WhatsApp: 01841246223</p>
        </div>
        <div>
          <small>ডেভেলপার: zubayer | যোগাযোগ: example@example.com</small>
        </div>
      </div>
    </footer>
  </div>

  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Firebase Initialization
    const firebaseConfig = {
      apiKey: "AIzaSyAlCr-cphqHaAGN8SoDJ_aOnVBzJOyFLyo",
      authDomain: "post-41a7c.firebaseapp.com",
      projectId: "post-41a7c",
      storageBucket: "post-41a7c.firebasestorage.app",
      messagingSenderId: "266157241851",
      appId: "1:266157241851:web:a36fe15cc1a46b01aac75e",
      measurementId: "G-GQ1BKHFPMP"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Global Variables
    let tasks = [];
    let selectedTaskId = null;
    let currentUserUid = null;
    let currentUserName = '';
    let currentUserEmail = '';
    let currentUserRole = 'user';
    let openComments = {};
    let selectedComment = null; // For comment edit/delete

    // DOM Elements
    const taskContainer = document.getElementById('taskContainer');
    const searchBox = document.getElementById('searchBox');
    const searchIconBtn = document.getElementById('searchIconBtn');
    const profileIconBtn = document.getElementById('profileIconBtn');
    const addTaskBtn = document.getElementById('addTaskBtn');

    // Task Modals
    const newTaskNameEl = document.getElementById('newTaskName');
    const newTaskPriorityEl = document.getElementById('newTaskPriority');
    const newTaskProgressEl = document.getElementById('newTaskProgress');
    const saveNewTaskBtn = document.getElementById('saveNewTaskBtn');
    const addTaskModal = new bootstrap.Modal(document.getElementById('addTaskModal'));

    const editTaskNameEl = document.getElementById('editTaskName');
    const editTaskPriorityEl = document.getElementById('editTaskPriority');
    const editTaskProgressEl = document.getElementById('editTaskProgress');
    const saveEditTaskBtn = document.getElementById('saveEditTaskBtn');
    const editTaskModal = new bootstrap.Modal(document.getElementById('editTaskModal'));

    const deleteTaskModal = new bootstrap.Modal(document.getElementById('deleteTaskModal'));
    const confirmDeleteTaskBtn = document.getElementById('confirmDeleteTaskBtn');

    // Update Progress Modal
    const updateProgressModal = new bootstrap.Modal(document.getElementById('updateProgressModal'));
    const newProgressInput = document.getElementById('newProgressInput');
    const saveProgressBtn = document.getElementById('saveProgressBtn');

    // Task Options Modal
    const taskOptionsModal = new bootstrap.Modal(document.getElementById('taskOptionsModal'));

    // Comment Modals
    const commentOptionsModal = new bootstrap.Modal(document.getElementById('commentOptionsModal'));
    const commentEditModal = new bootstrap.Modal(document.getElementById('commentEditModal'));
    const commentDeleteModal = new bootstrap.Modal(document.getElementById('commentDeleteModal'));
    const editCommentInput = document.getElementById('editCommentInput');
    const saveCommentEditBtn = document.getElementById('saveCommentEditBtn');
    const confirmCommentDeleteBtn = document.getElementById('confirmCommentDeleteBtn');

    // Profile & Password Modals
    const profileModal = new bootstrap.Modal(document.getElementById('profileModal'));
    const userNameDisplay = document.getElementById('userNameDisplay');
    const userEmailDisplay = document.getElementById('userEmailDisplay');
    const userRoleDisplay = document.getElementById('userRoleDisplay');
    const modalLogoutBtn = document.getElementById('modalLogoutBtn');

    const toastContainer = document.getElementById('toastContainer');

    /* ================= Utility Functions ================= */
    function formatTimestamp(ts) {
      if (!ts) return '';
      const date = ts.toDate();
      const dd = String(date.getDate()).padStart(2, '0');
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const yyyy = date.getFullYear();
      let hours = date.getHours();
      const min = String(date.getMinutes()).padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      if (hours === 0) hours = 12;
      const strHours = String(hours).padStart(2, '0');
      return `${dd}-${mm}-${yyyy}, ${strHours}:${min} ${ampm}`;
    }
    function formatDateTime(ts) { return formatTimestamp(ts); }
    function getProgressTitle(progress) {
      if (progress === 0) return "Not Started 😴";
      else if (progress > 0 && progress < 100) return "In Progress ⏳";
      else if (progress === 100) return "Completed ✅";
      else return "";
    }
    function showToast(message) {
      const toastEl = document.createElement('div');
      toastEl.className = 'toast align-items-center toast-dark-bg border-0 show';
      toastEl.style.minWidth = '200px';
      toastEl.setAttribute('role', 'alert');
      toastEl.setAttribute('aria-live', 'assertive');
      toastEl.setAttribute('aria-atomic', 'true');
      toastEl.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      toastContainer.appendChild(toastEl);
      setTimeout(() => { toastEl.classList.remove('show'); toastEl.remove(); }, 3000);
    }

    /* ================= Search Functionality ================= */
    searchIconBtn.addEventListener('click', () => {
      searchBox.classList.toggle('active');
      if (searchBox.classList.contains('active')) { searchBox.focus(); }
      else { searchBox.value = ""; renderTasks(); }
    });
    searchBox.addEventListener('input', renderTasks);

    /* ================= Auth State Listener ================= */
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUserUid = user.uid;
        db.collection("users").doc(user.uid).get().then(doc => {
          if (doc.exists) {
            const data = doc.data();
            currentUserName = user.displayName || data.name || "anonymous";
            currentUserEmail = data.email || "";
            currentUserRole = data.role || "user";
          }
          document.getElementById('app-section').style.display = "block";
          profileIconBtn.style.display = "inline-block";
          if (currentUserRole !== 'admin') { addTaskBtn.style.display = "none"; }
          if (currentUserRole === 'admin') {
            document.getElementById('editTaskOptionBtn').style.display = 'inline-block';
          } else {
            document.getElementById('editTaskOptionBtn').style.display = 'none';
          }
          userNameDisplay.innerText = "নাম: " + currentUserName;
          userEmailDisplay.innerText = "ইমেইল: " + currentUserEmail;
          userRoleDisplay.innerText = "রোল: " + currentUserRole;
          loadTasks();
        }).catch(err => console.error("তথ্য লোড করতে সমস্যা:", err));
      } else {
        document.getElementById('app-section').style.display = "none";
        profileIconBtn.style.display = "none";
        window.location.href = "login.html";
      }
    });

    function logout() { auth.signOut().then(() => console.log("লগআউট সফল")); }
    modalLogoutBtn.addEventListener('click', () => { logout(); profileModal.hide(); });
    profileIconBtn.addEventListener('click', () => { profileModal.show(); });

    /* ================= Role Based Check ================= */
    function requireAdmin(actionName) {
      if (currentUserRole !== 'admin') { showToast(`Access Denied! শুধুমাত্র এডমিন ${actionName} করতে পারবেন।`); return false; }
      return true;
    }

    /* ================= Load & Render Tasks ================= */
    function loadTasks() {
      db.collection('tasks').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
        tasks = [];
        snapshot.forEach(doc => { let data = doc.data(); data.id = doc.id; tasks.push(data); });
        renderTasks();
      });
    }

    function renderTasks() {
      taskContainer.innerHTML = '';
      const query = searchBox.value.trim().toLowerCase();
      let filteredTasks = tasks;
      if (query) { filteredTasks = tasks.filter(task => task.name.toLowerCase().includes(query)); }
      filteredTasks.forEach(task => {
        const createdAt = task.timestamp ? formatTimestamp(task.timestamp) : "N/A";
        const progressUpdated = task.progressTimestamp ? formatTimestamp(task.progressTimestamp) : "N/A";
        const taskNameClass = (task.progress === 100) ? 'text-decoration-line-through' : '';

        // Render comments (no reply/like system)
        let commentsHtml = '';
        if (task.comments && task.comments.length > 0) {
          task.comments.sort((a, b) => a.timestamp.seconds - b.timestamp.seconds);
          task.comments.forEach(cmt => {
            let commentOptionsBtn = `<button class="comment-options-btn" onclick="openCommentOptions(this, '${task.id}')">
                                        <i class="bi bi-three-dots"></i>
                                      </button>`;
            commentsHtml += `
              <div class="comment"
                   data-comment-timestamp="${cmt.timestamp.seconds}"
                   data-comment-text="${cmt.comment}"
                   data-comment-name="${cmt.name || 'anonymous'}"
                   data-comment-userid="${cmt.userId || ''}">
                <div class="comment-header">
                  <span class="comment-author">${cmt.name || "anonymous"}</span>
                  ${commentOptionsBtn}
                </div>
                <div class="comment-timestamp">${cmt.timestamp ? formatDateTime(cmt.timestamp) : ''}</div>
                <div class="comment-text">${cmt.comment}</div>
              </div>
            `;
          });
        }

        // Task options button – always visible.
        const taskEditBtn = `<button class="dot-btn" onclick="handleThreeDots('${task.id}')">
                                <i class="bi bi-three-dots-vertical"></i>
                              </button>`;

        const isOpen = openComments[task.id] === true;
        const commentCount = task.comments ? task.comments.length : 0;
        const toggleText = isOpen 
                           ? `<i class="bi bi-chat-left-text"></i> Show Less`
                           : `<i class="bi bi-chat-left-text"></i> Show More (${commentCount} comments)`;

        const card = document.createElement('div');
        card.className = 'card shadow mb-3';
        card.setAttribute('data-task-id', task.id);
        card.innerHTML = `
          <div class="card-header">
            <div>
              <h5 class="mb-0 ${taskNameClass}">${task.name}</h5>
              <small class="timestamp"><i class="bi bi-clock-history"></i> Created: ${createdAt}</small>
            </div>
            ${taskEditBtn}
          </div>
          <div class="card-body">
            <div class="priority-line">
              <small>Priority:</small>
              <span class="ms-1 badge ${
                task.priority === 'low' ? 'bg-success' : 
                task.priority === 'medium' ? 'bg-warning' : 'bg-danger'
              }">
                ${task.priority.toUpperCase()}
              </span>
            </div>
            <div class="status-line">
              <small>Status:</small>
              <div class="task-progress ms-2" ondblclick="openProgressModal('${task.id}', ${task.progress})">
                <div class="progress" style="height:25px; width:150px;">
                  <div class="progress-bar bg-info" role="progressbar" style="width: ${task.progress}%;" aria-valuenow="${task.progress}" aria-valuemin="0" aria-valuemax="100">
                    ${task.progress}%
                  </div>
                </div>
                <p class="progress-text mb-1">${getProgressTitle(task.progress)}</p>
                <small class="progress-timestamp"><i class="bi bi-clock"></i> Last Updated: ${progressUpdated}</small>
              </div>
            </div>
            <a class="show-more" onclick="toggleCommentSection(this, '${task.id}')">
              ${toggleText}
            </a>
            <div class="comment-section" style="display: ${isOpen ? "block" : "none"};">
              <div class="comment-list">${commentsHtml}</div>
              <div class="input-group mt-2">
                <input type="text" class="form-control comment-input" placeholder="কমেন্ট লিখুন" />
                <button class="btn btn-outline-secondary comment-submit" type="button" onclick="submitComment('${task.id}', this)">Send</button>
              </div>
            </div>
          </div>
        `;
        taskContainer.appendChild(card);
      });
    }
    searchBox.addEventListener('input', renderTasks);
    function toggleCommentSection(linkEl, taskId) { openComments[taskId] = !openComments[taskId]; renderTasks(); }

    /* ================= Handle Task Options (Three Dots) ================= */
    function handleThreeDots(taskId) {
      selectedTaskId = taskId;
      taskOptionsModal.show();
    }
    window.handleThreeDots = handleThreeDots;
    document.getElementById('downloadTaskBtn')?.addEventListener('click', () => {
      const card = document.querySelector(`[data-task-id="${selectedTaskId}"]`);
      html2canvas(card).then(canvas => {
        const link = document.createElement('a');
        link.download = "task.png";
        link.href = canvas.toDataURL();
        link.click();
        taskOptionsModal.hide();
      }).catch(err => { console.error(err); showToast("ডাউনলোড করতে সমস্যা হয়েছে!"); });
    });
    document.getElementById('editTaskOptionBtn')?.addEventListener('click', () => {
      taskOptionsModal.hide();
      if (currentUserRole === 'admin') { openEditModal(selectedTaskId); }
    });

    /* ================= Update Progress Modal ================= */
    function openProgressModal(taskId, currentProgress) {
      if (!requireAdmin("প্রগ্রেস আপডেট করতে")) return;
      selectedTaskId = taskId;
      newProgressInput.value = currentProgress;
      updateProgressModal.show();
    }
    window.openProgressModal = openProgressModal;
    saveProgressBtn.addEventListener('click', () => {
      const newProgress = parseInt(newProgressInput.value);
      if (isNaN(newProgress) || newProgress < 0 || newProgress > 100) { showToast("সঠিক মান (0-100) দিন!"); return; }
      db.collection('tasks').doc(selectedTaskId).update({
        progress: newProgress,
        progressTimestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => { showToast("প্রগ্রেস আপডেট হয়েছে!"); updateProgressModal.hide(); })
      .catch(err => { console.error(err); showToast("আপডেট করতে সমস্যা হয়েছে!"); });
    });

    /* ================= Comment Options Handling ================= */
    function openCommentOptions(btn, taskId) {
      const commentDiv = btn.closest('.comment');
      const commentTimestamp = commentDiv.getAttribute('data-comment-timestamp');
      const commentText = commentDiv.getAttribute('data-comment-text');
      const commentUserId = commentDiv.getAttribute('data-comment-userid');
      // যদি নিজস্ব কমেন্ট হয়, তাহলে মোডালে এডিট ও ডিলিট দেখানো হবে
      if (commentUserId === currentUserUid) {
        selectedComment = { taskId, timestamp: commentTimestamp, text: commentText, userId: commentUserId };
        // সর্বদা নিজের কমেন্টে এডিট ও ডিলিট অপশন দেখান
        document.getElementById('editCommentBtn').style.display = 'inline-block';
        commentOptionsModal.show();
      }
      // অন্য কারো কমেন্টে ক্লিক করলে, কিছুই না
    }
    window.openCommentOptions = openCommentOptions;
    
    // Comment Edit
    document.getElementById('editCommentBtn').addEventListener('click', () => {
      commentOptionsModal.hide();
      if (selectedComment) {
        editCommentInput.value = selectedComment.text;
        commentEditModal.show();
      }
    });
    // Save Comment Edit
    saveCommentEditBtn.addEventListener('click', () => {
      const newText = editCommentInput.value.trim();
      if (newText === "") { showToast("কমেন্ট খালি হতে পারে না!"); return; }
      const taskRef = db.collection('tasks').doc(selectedComment.taskId);
      taskRef.get().then(doc => {
        if (doc.exists) {
          const taskData = doc.data();
          const oldComments = taskData.comments || [];
          let oldComment = null;
          oldComments.forEach(c => { if (c.timestamp.seconds == selectedComment.timestamp) { oldComment = c; } });
          if (oldComment) {
            const updatedComment = { ...oldComment, comment: newText };
            taskRef.update({ comments: firebase.firestore.FieldValue.arrayRemove(oldComment) })
            .then(() => { return taskRef.update({ comments: firebase.firestore.FieldValue.arrayUnion(updatedComment) }); })
            .then(() => { showToast("কমেন্ট আপডেট হয়েছে!"); commentEditModal.hide(); })
            .catch(err => { console.error(err); showToast("কমেন্ট আপডেট করতে সমস্যা হয়েছে!"); });
          }
        }
      });
    });
    // Comment Delete
    document.getElementById('deleteCommentBtn').addEventListener('click', () => {
      commentOptionsModal.hide();
      commentDeleteModal.show();
    });
    document.getElementById('confirmCommentDeleteBtn').addEventListener('click', () => {
      const taskRef = db.collection('tasks').doc(selectedComment.taskId);
      taskRef.get().then(doc => {
        if (doc.exists) {
          const taskData = doc.data();
          const oldComments = taskData.comments || [];
          let oldComment = null;
          oldComments.forEach(c => { if (c.timestamp.seconds == selectedComment.timestamp) { oldComment = c; } });
          if (oldComment) {
            taskRef.update({ comments: firebase.firestore.FieldValue.arrayRemove(oldComment) })
            .then(() => { showToast("কমেন্ট ডিলিট হয়েছে!"); commentDeleteModal.hide(); })
            .catch(err => { console.error(err); showToast("কমেন্ট ডিলিট করতে সমস্যা হয়েছে!"); });
          }
        }
      });
    });

    /* ================= Task CRUD ================= */
    saveNewTaskBtn.addEventListener('click', () => {
      if (!requireAdmin("যোগ করতে")) return;
      const name = newTaskNameEl.value.trim();
      if (name === "") { showToast("টাস্কের নাম লিখুন!"); return; }
      const priority = newTaskPriorityEl.value;
      const progress = parseInt(newTaskProgressEl.value) || 0;
      db.collection('tasks').add({
        name, priority, progress,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        progressTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
        comments: []
      }).then(() => {
        showToast("টাস্ক সফলভাবে যোগ হয়েছে!");
        addTaskModal.hide();
        newTaskNameEl.value = "";
        newTaskProgressEl.value = "0";
      }).catch(err => { console.error(err); showToast("যোগ করতে সমস্যা হয়েছে!"); });
    });
    function openEditModal(taskId) {
      if (!requireAdmin("এডিট করতে")) return;
      selectedTaskId = taskId;
      const task = tasks.find(t => t.id === taskId);
      if (task) {
        editTaskNameEl.value = task.name;
        editTaskPriorityEl.value = task.priority;
        editTaskProgressEl.value = task.progress;
        editTaskModal.show();
      }
    }
    window.openEditModal = openEditModal;
    saveEditTaskBtn.addEventListener('click', () => {
      if (!requireAdmin("এডিট করতে")) return;
      const name = editTaskNameEl.value.trim();
      if (name === "") { showToast("টাস্কের নাম লিখুন!"); return; }
      const priority = editTaskPriorityEl.value;
      const progress = parseInt(editTaskProgressEl.value) || 0;
      db.collection('tasks').doc(selectedTaskId).update({
        name, priority, progress,
        progressTimestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => { showToast("টাস্ক সফলভাবে এডিট হয়েছে!"); editTaskModal.hide(); })
      .catch(err => { console.error(err); showToast("এডিট করতে সমস্যা হয়েছে!"); });
    });
    function onUpdateTaskProgress(taskId) {
      const task = tasks.find(t => t.id === taskId);
      openProgressModal(taskId, task ? task.progress : 0);
    }
    window.onUpdateTaskProgress = onUpdateTaskProgress;
    function openDeleteModal(taskId) {
      if (!requireAdmin("ডিলিট করতে")) return;
      selectedTaskId = taskId;
      deleteTaskModal.show();
    }
    window.openDeleteModal = openDeleteModal;
    confirmDeleteTaskBtn.addEventListener('click', () => {
      db.collection('tasks').doc(selectedTaskId).delete().then(() => {
        showToast("টাস্ক সফলভাবে ডিলিট হয়েছে!");
        deleteTaskModal.hide();
      }).catch(err => { console.error(err); showToast("টাস্ক ডিলিট করতে সমস্যা হয়েছে!"); });
    });
    function submitComment(taskId, btn) {
      const inputGroup = btn.parentElement;
      const commentInput = inputGroup.querySelector('.comment-input');
      const commentText = commentInput.value.trim();
      if (commentText === "") { showToast("কমেন্ট লিখুন!"); return; }
      const commentObj = {
        userId: currentUserUid,
        name: currentUserName || "anonymous",
        comment: commentText,
        timestamp: firebase.firestore.Timestamp.now(),
        likes: [],
        replies: []
      };
      db.collection('tasks').doc(taskId).update({
        comments: firebase.firestore.FieldValue.arrayUnion(commentObj)
      }).then(() => {
        showToast("কমেন্ট যোগ হয়েছে!");
        commentInput.value = "";
        openComments[taskId] = true;
        renderTasks();
      }).catch(err => { console.error(err); showToast("কমেন্ট যোগ করতে সমস্যা হয়েছে!"); });
    }
    window.submitComment = submitComment;

    /* ================= Password Change Functionality ================= */
    document.getElementById('changePasswordBtn').addEventListener('click', () => {
      const currentPassword = document.getElementById('currentPassword').value.trim();
      const newPassword = document.getElementById('newPassword').value.trim();
      const confirmPassword = document.getElementById('confirmPassword').value.trim();
      if (!currentPassword || !newPassword || !confirmPassword) { showToast("সব ইনপুট পূরণ করুন!"); return; }
      if (newPassword !== confirmPassword) { showToast("নতুন পাসওয়ার্ড মিলছে না!"); return; }
      // এখানে reauthenticate() ও updatePassword() ব্যবহার করে বাস্তবে পাসওয়ার্ড পরিবর্তন করা উচিত।
      showToast("পাসওয়ার্ড সফলভাবে পরিবর্তিত হয়েছে!");
      document.getElementById('currentPassword').value = "";
      document.getElementById('newPassword').value = "";
      document.getElementById('confirmPassword').value = "";
      bootstrap.Modal.getInstance(document.getElementById('passwordModal')).hide();
    });

    // Start loading tasks
    loadTasks();
  </script>
</body>
</html>
